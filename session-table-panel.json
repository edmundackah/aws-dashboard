{
  "datasource": {
    "type": "prometheus",
    "uid": "${datasource}"
  },
  "description": "Detailed session information with errors and browser details",
  "fieldConfig": {
    "defaults": {
      "color": {
        "mode": "thresholds"
      },
      "custom": {
        "align": "auto",
        "cellOptions": {
          "type": "auto"
        },
        "inspect": false
      },
      "mappings": [],
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {
            "color": "green",
            "value": null
          }
        ]
      }
    },
    "overrides": [
      {
        "matcher": {
          "id": "byName",
          "options": "Timestamp"
        },
        "properties": [
          {
            "id": "unit",
            "value": "dateTimeAsIso"
          },
          {
            "id": "custom.width",
            "value": 180
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "Errors"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 80
          },
          {
            "id": "color",
            "value": {
              "mode": "thresholds"
            }
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "green",
                  "value": null
                },
                {
                  "color": "green",
                  "value": 0
                },
                {
                  "color": "yellow",
                  "value": 1
                },
                {
                  "color": "red",
                  "value": 5
                }
              ]
            }
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "color-text"
            }
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "Session ID"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 120
          },
          {
            "id": "links",
            "value": [
              {
                "title": "View Session Details",
                "url": "/d/session-details?var-session_id=${__value.text}"
              }
            ]
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "Page ID"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 200
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "Browser Name"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 150
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "Browser Version"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 100
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "Platform"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 120
          }
        ]
      }
    ]
  },
  "gridPos": {
    "h": 12,
    "w": 24,
    "x": 0,
    "y": 0
  },
  "id": 100,
  "options": {
    "cellHeight": "sm",
    "footer": {
      "countRows": false,
      "enablePagination": true,
      "fields": "",
      "reducer": [
        "sum"
      ],
      "show": false
    },
    "frameIndex": 0,
    "showHeader": true,
    "sortBy": [
      {
        "desc": true,
        "displayName": "Timestamp"
      }
    ]
  },
  "pluginVersion": "10.2.0",
  "targets": [
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "editorMode": "code",
      "expr": "max by (session_id)(timestamp(loki_process_custom_faro_session_events_total{app_name=\"$app\"}))",
      "format": "table",
      "instant": true,
      "refId": "Timestamp"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "editorMode": "code",
      "expr": "sum by (session_id)(increase(loki_process_custom_faro_session_errors_total{app_name=\"$app\"}[$__range]))",
      "format": "table",
      "instant": true,
      "refId": "Errors"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "editorMode": "code",
      "expr": "topk by (session_id) (1, max by (session_id, page_id)(loki_process_custom_faro_session_pageviews_total{app_name=\"$app\"}))",
      "format": "table",
      "instant": true,
      "refId": "PageID"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "editorMode": "code",
      "expr": "topk by (session_id) (1, max by (session_id, browser_name)(loki_process_custom_faro_session_events_total{app_name=\"$app\"}))",
      "format": "table",
      "instant": true,
      "refId": "Browser"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "editorMode": "code",
      "expr": "topk by (session_id) (1, label_join(max by (session_id, browser_name)(loki_process_custom_faro_session_events_total{app_name=\"$app\"}), \"browser_version\", \"\", \"browser_name\"))",
      "format": "table",
      "instant": true,
      "refId": "BrowserVersion"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "editorMode": "code",
      "expr": "topk by (session_id) (1, label_join(max by (session_id, browser_name)(loki_process_custom_faro_session_events_total{app_name=\"$app\"}), \"platform\", \"\", \"browser_name\"))",
      "format": "table",
      "instant": true,
      "refId": "Platform"
    }
  ],
  "title": "Sessions",
  "transformations": [
    {
      "id": "merge",
      "options": {}
    },
    {
      "id": "groupBy",
      "options": {
        "fields": {
          "Value #Browser": {
            "aggregations": [],
            "operation": "groupby"
          },
          "Value #BrowserVersion": {
            "aggregations": [],
            "operation": "groupby"
          },
          "Value #Errors": {
            "aggregations": [],
            "operation": "groupby"
          },
          "Value #PageID": {
            "aggregations": [],
            "operation": "groupby"
          },
          "Value #Platform": {
            "aggregations": [],
            "operation": "groupby"
          },
          "Value #Timestamp": {
            "aggregations": [],
            "operation": "groupby"
          },
          "browser_name": {
            "aggregations": [],
            "operation": "groupby"
          },
          "browser_version": {
            "aggregations": [],
            "operation": "groupby"
          },
          "page_id": {
            "aggregations": [],
            "operation": "groupby"
          },
          "platform": {
            "aggregations": [],
            "operation": "groupby"
          },
          "session_id": {
            "aggregations": [],
            "operation": "groupby"
          }
        }
      }
    },
    {
      "id": "organize",
      "options": {
        "excludeByName": {
          "Value #Browser": true,
          "Value #BrowserVersion": true,
          "Value #PageID": true,
          "Value #Platform": true,
          "browser_version": true,
          "platform": true
        },
        "indexByName": {
          "Value #Timestamp": 0,
          "Value #Errors": 1,
          "session_id": 2,
          "page_id": 3,
          "browser_name": 4,
          "browser_version": 5,
          "platform": 6
        },
        "renameByName": {
          "Value #Errors": "Errors",
          "Value #Timestamp": "Timestamp",
          "browser_name": "Browser Name",
          "browser_version": "Browser Version",
          "page_id": "Page ID",
          "platform": "Platform",
          "session_id": "Session ID"
        }
      }
    },
    {
      "id": "calculateField",
      "options": {
        "mode": "reduceRow",
        "reduce": {
          "reducer": "allValues",
          "include": ["Browser Name"]
        },
        "replaceFields": false,
        "alias": "Browser Version"
      }
    },
    {
      "id": "calculateField",
      "options": {
        "mode": "reduceRow",
        "reduce": {
          "reducer": "allValues",
          "include": ["Browser Name"]
        },
        "replaceFields": false,
        "alias": "Platform"
      }
    }
  ],
  "type": "table"
}

